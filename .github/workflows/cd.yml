name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    # Only deploy if CI succeeded on main/master branch
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master') ||
      github.event_name == 'workflow_dispatch'

    steps:
      # ----------------------------------------------------
      # 1. Checkout (for reference)
      # ----------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Deploy to Kubernetes
      # ----------------------------------------------------
      - name: Deploy to K3s Cluster
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "=== Starting Kubernetes Deployment ==="
            
            # Set kubectl config
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
            
            # Verify cluster is ready
            sudo kubectl get nodes
            
            # Create/update deployment manifest with latest image tag
            cat << 'DEPLOYMENT_EOF' | sudo tee /tmp/notes-api-deployment.yaml
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: notes-api
              namespace: notes-api
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: notes-api
              template:
                metadata:
                  labels:
                    app: notes-api
                spec:
                  containers:
                  - name: notes-api
                    image: ${{ secrets.DOCKERHUB_USERNAME }}/notes-api:latest
                    imagePullPolicy: Always
                    ports:
                    - containerPort: 5000
                    env:
                    - name: NODE_ENV
                      value: "production"
                    - name: PORT
                      value: "5000"
                    - name: MONGODB_URI
                      value: "mongodb://mongodb.notes-api.svc.cluster.local:27017/notes"
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "500m"
                    readinessProbe:
                      httpGet:
                        path: /api/health
                        port: 5000
                      initialDelaySeconds: 10
                      periodSeconds: 5
                    livenessProbe:
                      httpGet:
                        path: /api/health
                        port: 5000
                      initialDelaySeconds: 15
                      periodSeconds: 10
            DEPLOYMENT_EOF
            
            # Apply the deployment
            sudo kubectl apply -f /tmp/notes-api-deployment.yaml
            
            # Wait for rollout to complete
            sudo kubectl rollout status deployment/notes-api -n notes-api --timeout=120s
            
            # Verify pods are running
            echo ""
            echo "=== Pod Status ==="
            sudo kubectl get pods -n notes-api -l app=notes-api
            
            echo ""
            echo "Deployment completed successfully!"

      # ----------------------------------------------------
      # 3. Health Check Verification
      # ----------------------------------------------------
      - name: Verify Deployment Health
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 15
          
          echo "Running health check..."
          for i in {1..5}; do
            RESPONSE=$(curl -sf http://${{ secrets.EC2_HOST }}:30000/api/health 2>/dev/null)
            if [ $? -eq 0 ]; then
              echo "Health check passed!"
              echo "Response: $RESPONSE"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
          echo "Health check failed after 5 attempts"
          exit 1

      # ----------------------------------------------------
      # 4. DAST - Dynamic Application Security Testing
      # ----------------------------------------------------
      - name: DAST Security Scan
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "=== Starting DAST (Dynamic Application Security Testing) ==="
            
            APP_URL="http://localhost:30000"
            
            echo "Testing application at: ${APP_URL}"
            sleep 3
            
            # Test 1: Health endpoint accessibility
            echo ""
            echo "Test 1: Health Check"
            curl -sf "${APP_URL}/api/health" && echo " - Health endpoint accessible" || echo " - Health endpoint failed"
            
            # Test 2: Security Headers Check
            echo ""
            echo "Test 2: Security Headers"
            HEADERS=$(curl -sI "${APP_URL}/api/health" 2>/dev/null)
            
            echo "$HEADERS" | grep -qi "x-content-type-options" && echo " - X-Content-Type-Options: present" || echo " - X-Content-Type-Options: MISSING"
            echo "$HEADERS" | grep -qi "x-frame-options" && echo " - X-Frame-Options: present" || echo " - X-Frame-Options: MISSING"
            echo "$HEADERS" | grep -qi "x-dns-prefetch-control" && echo " - X-DNS-Prefetch-Control: present" || echo " - X-DNS-Prefetch-Control: MISSING"
            
            # Test 3: API Response Validation
            echo ""
            echo "Test 3: API Response Validation"
            RESPONSE=$(curl -s "${APP_URL}/api/health")
            echo "Response: ${RESPONSE}"
            
            # Test 4: 404 Handling
            echo ""
            echo "Test 4: 404 Error Handling"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${APP_URL}/nonexistent")
            echo "Non-existent route returns: HTTP ${STATUS}"
            
            echo ""
            echo "=== DAST Security Scan Completed ==="
            echo "Note: For production, consider OWASP ZAP or Burp Suite integration."

  # ----------------------------------------------------
  # Deployment Summary
  # ----------------------------------------------------
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "### Deployment: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Endpoint | URL |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| App | http://${{ secrets.EC2_HOST }}:30000 |" >> $GITHUB_STEP_SUMMARY
            echo "| Health | http://${{ secrets.EC2_HOST }}:30000/api/health |" >> $GITHUB_STEP_SUMMARY
            echo "| Docs | http://${{ secrets.EC2_HOST }}:30000/api/docs |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Deployment: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the deploy job logs for details." >> $GITHUB_STEP_SUMMARY
          fi
